services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        volumes:
            - "./storage:/var/www/html/storage"
        environment:
            - AUTORUN_ENABLED=true
            - AUTORUN_LARAVEL_MIGRATION_ISOLATION=true
            - APP_ENV
            - APP_KEY
            - APP_URL
            - APP_DEBUG
            - APP_LOCALE
            - APP_FALLBACK_LOCALE
            - APP_FAKER_LOCALE
            - APP_MAINTENANCE_DRIVER
            - APP_MAINTENANCE_STORE
            - BCRYPT_ROUNDS
            - LOG_CHANNEL
            - LOG_STACK
            - LOG_DEPRECATIONS_CHANNEL
            - LOG_LEVEL
            - DB_CONNECTION
            - DB_URL
            - SESSION_DRIVER
            - SESSION_LIFETIME
            - SESSION_ENCRYPT
            - SESSION_PATH
            - SESSION_DOMAIN
            - BROADCAST_CONNECTION
            - FILESYSTEM_DISK
            - QUEUE_CONNECTION
            - CACHE_STORE
            - CACHE_PREFIX
            - REDIS_CLIENT
            - REDIS_URL
            - MAIL_MAILER
            - MAIL_HOST
            - MAIL_PORT
            - MAIL_USERNAME
            - MAIL_PASSWORD
            - MAIL_ENCRYPTION
            - MAIL_FROM_ADDRESS
            - MAIL_FROM_NAME
            - AWS_ACCESS_KEY_ID
            - AWS_SECRET_ACCESS_KEY
            - AWS_DEFAULT_REGION
            - AWS_BUCKET
            - AWS_USE_PATH_STYLE_ENDPOINT
            - AWS_URL
            - AWS_ENDPOINT
            - VITE_APP_NAME
            - GOOGLE_CLIENT_ID
            - GOOGLE_CLIENT_SECRET
            - GOOGLE_CALLBACK_URL
            - CURRENCY_API_KEY
            - SYNTH_ACCESS_TOKEN
            - WORKSPACES_PROFILE_PHOTO_DISK
            - POLAR_ORGANIZATION_ID
            - POLAR_ACCESS_TOKEN
            - POLAR_WEBHOOK_SECRET
            - TELLER_KEY_BASE64
            - TELLER_SECRET_BASE64
            - TELLER_ENVIRONMENT
            - TELLER_APP_ID
            - TELLER_SIGNING_KEY
            - TELLER_PUBLIC_KEY
            - SCOUT_DRIVER=meilisearch
            - SCOUT_QUEUE=true
            - MEILISEARCH_HOST
            - MEILISEARCH_KEY
            - CLOUDINARY_URL
            - CLOUDINARY_UPLOAD_PRESET=ml_default
            - CLOUDINARY_NOTIFICATION_URL
            - SSR_URL=http://ssr:13714
        networks:
            - app_network

    task:
        build:
            context: .
            dockerfile: Dockerfile
        command: ["php", "/var/www/html/artisan", "schedule:work"]
        stop_signal: SIGTERM # Set this for graceful shutdown if you're using fpm-apache or fpm-nginx
        healthcheck:
            # This is our native healthcheck script for the scheduler
            test: ["CMD", "healthcheck-schedule"]
            start_period: 10s

    queue:
        build:
            context: .
            dockerfile: Dockerfile
        command: ["php", "/var/www/html/artisan", "queue:work", "--sleep=3", "--tries=3", "--max-time=3600"]
        stop_signal: SIGTERM # Set this for graceful shutdown if you're using fpm-apache or fpm-nginx
        healthcheck:
            # This is our native healthcheck script for the queue
            test: ["CMD", "healthcheck-queue"]
            start_period: 10s
        volumes:
            - "./storage:/var/www/html/storage"
        environment:
            PHP_FPM_POOL_NAME: app_queue
    bank_connection_queue:
        build:
            context: .
            dockerfile: Dockerfile
        command:
            [
                "php",
                "/var/www/html/artisan",
                "queue:work",
                "--queue=bank-connection",
                "--tries=3",
                "--max-time=3600",
                "--backoff=60",
            ]
        stop_signal: SIGTERM # Set this for graceful shutdown if you're using fpm-apache or fpm-nginx
        healthcheck:
            test: ["CMD", "healthcheck-queue"]
            start_period: 10s
        volumes:
            - "./storage:/var/www/html/storage"
        environment:
            PHP_FPM_POOL_NAME: bank_connection_queue

    ssr:
        build:
            context: .
            dockerfile: Dockerfile
        command: ["php", "/var/www/html/artisan", "inertia:start-ssr", "--runtime=bun"]
        ports:
            - "13714:13714"
        volumes:
            - "./storage:/var/www/html/storage"
        environment:
            PHP_FPM_POOL_NAME: app_ssr
        networks:
            - app_network

networks:
    app_network:
        driver: bridge
