services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        volumes:
            - "./storage:/var/www/html/storage"
        networks:
            - app_network

    task:
        build:
            context: .
            dockerfile: Dockerfile
        command: ["php", "/var/www/html/artisan", "schedule:work"]
        stop_signal: SIGTERM # Set this for graceful shutdown if you're using fpm-apache or fpm-nginx
        healthcheck:
            # This is our native healthcheck script for the scheduler
            test: ["CMD", "healthcheck-schedule"]
            start_period: 10s

    queue:
        build:
            context: .
            dockerfile: Dockerfile
        command: ["php", "/var/www/html/artisan", "queue:work", "--sleep=3", "--tries=3", "--max-time=3600"]
        stop_signal: SIGTERM # Set this for graceful shutdown if you're using fpm-apache or fpm-nginx
        healthcheck:
            # This is our native healthcheck script for the queue
            test: ["CMD", "healthcheck-queue"]
            start_period: 10s
        volumes:
            - "./storage:/var/www/html/storage"
        environment:
            PHP_FPM_POOL_NAME: app_queue
    bank_connection_queue:
        build:
            context: .
            dockerfile: Dockerfile
        command:
            [
                "php",
                "/var/www/html/artisan",
                "queue:work",
                "--queue=bank-connection",
                "--tries=3",
                "--max-time=3600",
                "--backoff=60",
            ]
        stop_signal: SIGTERM # Set this for graceful shutdown if you're using fpm-apache or fpm-nginx
        healthcheck:
            test: ["CMD", "healthcheck-queue"]
            start_period: 10s
        volumes:
            - "./storage:/var/www/html/storage"
        environment:
            PHP_FPM_POOL_NAME: bank_connection_queue

    ssr:
        build:
            context: .
            dockerfile: Dockerfile
        command: ["php", "/var/www/html/artisan", "inertia:start-ssr", "--runtime=bun"]
        ports:
            - "13714:13714"
        volumes:
            - "./storage:/var/www/html/storage"
        environment:
            PHP_FPM_POOL_NAME: app_ssr
        networks:
            - app_network

networks:
    app_network:
        driver: bridge
